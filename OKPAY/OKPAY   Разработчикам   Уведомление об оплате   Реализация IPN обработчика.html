<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<!-- saved from url=(0057)https://www.okpay.com/ru/developers/ipn/code-samples.html -->
<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>
OKPAY | Разработчикам | Уведомление об оплате | Реализация IPN обработчика
</title><meta name="yandex-verification" content="69ef238690342457">
<script type="text/javascript" async="" src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/ga.js"></script><script type="text/javascript">
var _gaq = _gaq || []; _gaq.push(['_setAccount', 'UA-10794252-3']); _gaq.push(['_trackPageview']);
(function () {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>
<meta name="Description"><meta name="Keywords"><link type="text/css" rel="stylesheet" href="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/layout.css"><link type="opera/css" href="https://www.okpay.com/css/scroll_old.css"><link type="application/rss+xml" rel="alternate" title="OKPAY News" href="https://www.okpay.com/ru/company/news/news.rss"><!--[if IE 6]><link rel="stylesheet" href="/css/ie6.css" media="all" /><![endif]--><!--[if IE 7]><link rel="stylesheet" href="/css/ie6.css" media="all" /><![endif]--></head>
<body>
<form name="aspnetForm" method="post" action="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика.html" id="aspnetForm">
<div>
<input type="hidden" name="__VIEWSTATE" id="__VIEWSTATE" value="/wEPDwULLTExMDc4NjQ1MzRkZBM7hPO0KTj9hnl6ArbrwUR2Dkjg">
</div>
<script type="text/javascript" src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/jquery.min.js"></script><script type="text/javascript">if (typeof jQuery == 'undefined'){document.write(unescape("%3Cscript src='/js/jquery.js' type='text/javascript'%3E%3C/script%3E"));}</script>
<div id="header">
<div class="welcome">
<div id="dvLogin">
Добро пожаловать! <a href="https://www.okpay.com/ru/account/login.html">Войти в ваш аккаунт</a> или <a href="https://www.okpay.com/ru/account/signup.html">открыть новый счет</a>.
</div>
</div>
<div class="topline">
<div class="language">
<img class="arrow" src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/header_lang_arrow.gif" alt="">
<div id="LangPanel1_dvcurLang" style="margin:0 8px; padding: 4px 0;"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/ru.png" alt="Русский">Русский</div>
<div id="LangPanel1_dvOtherLang" class="languages">
<a href="https://www.okpay.com/en/developers/ipn/code-samples.html"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/us.png" alt=""><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/gb.png" style="margin-left:-5px;" alt="English">English</a><a href="https://www.okpay.com/es/developers/ipn/code-samples.html"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/es.png" alt="Español">Español</a><a href="https://www.okpay.com/de/developers/ipn/code-samples.html"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/de.png" alt="Deutsch">Deutsch</a><a href="https://www.okpay.com/it/developers/ipn/code-samples.html"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/it.png" alt="Italiano">Italiano</a><a href="https://www.okpay.com/cn/developers/ipn/code-samples.html"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/cn.png" alt="中国">中国</a><a href="https://www.okpay.com/th/developers/ipn/code-samples.html"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/th.png" alt="ไทย">ไทย</a><a href="https://www.okpay.com/vn/developers/ipn/code-samples.html"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/vn.png" alt="Việt">Việt</a><a href="https://www.okpay.com/ms/developers/ipn/code-samples.html"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/ms.png" alt="Melayu">Melayu</a><a href="https://www.okpay.com/et/developers/ipn/code-samples.html"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/et.png" alt="Eesti">Eesti</a><a href="https://www.okpay.com/hu/developers/ipn/code-samples.html"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/hu.png" alt="Magyar">Magyar</a><a href="https://www.okpay.com/pl/developers/ipn/code-samples.html"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/pl.png" alt="Polski">Polski</a><a href="https://www.okpay.com/fa/developers/ipn/code-samples.html"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/fa.png" alt="فارسی">فارسی</a><a href="https://www.okpay.com/ar/developers/ipn/code-samples.html"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/ar.png" alt=" العربية"> العربية</a></div>
</div>
<div class="support">
Нужна помощь? <br><a href="https://www.okpay.com/ru/support/index.html">Напишите</a> или <a href="https://www.okpay.com/ru/support/index.html#Talk">Позвоните</a>
</div>
</div>
<ul id="navigation">
<li class="logo ">
<a href="https://www.okpay.com/ru/index.html">
платежи —<br>это&nbsp;просто!
</a>
</li>
<li>
<a href="https://www.okpay.com/ru/solutions/index.html">Решения</a>
</li>
<li>
<a href="https://www.okpay.com/ru/support/index.html">Поддержка</a>
</li>
<li class="active">
<a href="https://www.okpay.com/ru/developers/index.html">Разработчикам</a>
</li>
<li>
<a href="https://www.okpay.com/ru/account/index.html">Мой счет</a>
</li>
</ul>
<div class="search">
<input type="text" name="txtSearch" id="txtSearch" class="field" value="Поиск" onfocus="this.value=(this.value==&#39;Поиск&#39;)?&#39;&#39;:this.value; $(this).css(&#39;color&#39;,&#39;#000&#39;);" onblur="this.value=(this.value==&#39;&#39;)?&#39;Поиск&#39;:this.value; $(this).css(&#39;color&#39;,&#39;#C2C2C2&#39;);" onkeypress="return SubmitOnEnter(this,event)">
<input type="button" name="btnSearch" id="btnSearch" class="button" onclick="SearchSite();">
</div>
<!--
<div class="marketplace">
<a href="/ru/marketplace/index.html">
<img src="/img/marketplace/market_logo_mini.png" alt="Marketplace" />
</a>
</div> -->
<div id="dvBottombar" class="bottombar">
<ul id="secondary">
<li class="f"><a href="https://www.okpay.com/ru/developers/marketplace/index.html">Каталог товаров</a></li>
<li><a href="https://www.okpay.com/ru/developers/paylinks/index.html">Ссылки на оплату</a></li>
<li><a href="https://www.okpay.com/ru/developers/seal/index.html">Печать OKPAY</a></li>
<li><a href="https://www.okpay.com/ru/developers/ipn/index.html">Уведомление об оплате</a></li>
<li><a href="https://www.okpay.com/ru/developers/interfaces/index.html">Интерфейсы</a></li>
<li><a href="https://www.okpay.com/ru/developers/currency-codes.html">Коды валют</a></li>
<li><a href="https://www.okpay.com/ru/developers/shop-systems/index.html">Системы магазинов</a></li>
</ul>
</div>
</div>
<div id="wrap">
<div id="sbarglobal" class="sidebar-global">
<script type="text/javascript">
$(document).ready(function() {
var cur_category = $("ul.navigation>li.active"); $("ul.navigation>li>a").mouseover(function() {
if ($(this).parent().html() != cur_category.html()) {if (cur_category) {cur_category.children("ul.dropdown").slideUp(300);}
$(this).parent().children("ul.dropdown").slideDown(300);cur_category = $(this).parent();}return false;
});
});
</script>
<div class="navigation_corners">
<div class="tr">
<div class="br">
<div class="bl">
<ul class="navigation">
<li><a href="https://www.okpay.com/ru/developers/index.html">Инструменты продавцов</a></li>
<ul class="subitem">
</ul>
<li><a href="https://www.okpay.com/ru/developers/assistance.html"></a></li>
<ul class="subitem">
</ul>
<li><a href="https://www.okpay.com/ru/developers/marketplace/index.html">Каталог товаров</a></li>
<ul class="subitem">
</ul>
<li><a href="https://www.okpay.com/ru/developers/paylinks/index.html">Ссылки на оплату</a></li>
<ul class="subitem">
<li><a href="https://www.okpay.com/ru/developers/paylinks/index.html">Обзор</a></li>
<li><a href="https://www.okpay.com/ru/developers/paylinks/generator.html">Генерация</a></li>
<li><a href="https://www.okpay.com/ru/developers/paylinks/buttons.html">Кнопки</a></li>
<li><a href="https://www.okpay.com/ru/developers/paylinks/variables.html">Справочник</a></li>
<li><a href="https://www.okpay.com/ru/developers/paylinks/auto-return.html">URL авто-возврата</a></li>
<li><a href="https://www.okpay.com/ru/developers/paylinks/code-samples.html">Code Samples</a></li>
</ul>
<li><a href="https://www.okpay.com/ru/developers/seal/index.html">Печать OKPAY</a></li>
<ul class="subitem">
</ul>
<li><a href="https://www.okpay.com/ru/developers/ipn/index.html">Уведомление об оплате</a></li>
<ul class="subitem">
<li><a href="https://www.okpay.com/ru/developers/ipn/index.html">Обзор IPN</a></li>
<li class="active"><a href="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика.html">Примеры кода</a></li>
<li><a href="https://www.okpay.com/ru/developers/ipn/history.html">История</a></li>
<li><a href="https://www.okpay.com/ru/developers/ipn/setup.html">Настройка</a></li>
<li><a href="https://www.okpay.com/ru/developers/ipn/testing.html">Тестирование</a></li>
<li><a href="https://www.okpay.com/ru/developers/ipn/variables.html">Справочник</a></li>
</ul>
<li><a href="https://www.okpay.com/ru/developers/interfaces/index.html">Интерфейсы</a></li>
<ul class="subitem">
<li><a href="https://www.okpay.com/ru/developers/interfaces/index.html">Обзор API</a></li>
<li><a href="https://www.okpay.com/ru/developers/interfaces/setup.html">Настройка</a></li>
<li><a href="https://www.okpay.com/ru/developers/interfaces/definitions.html">Определения</a></li>
<li><a href="https://www.okpay.com/ru/developers/interfaces/functions/index.html">Функции</a></li>
<li><a href="https://www.okpay.com/ru/developers/interfaces/code-samples.html">Примеры кода</a></li>
</ul>
<li><a href="https://www.okpay.com/ru/developers/currency-codes.html">Коды валют</a></li>
<ul class="subitem">
</ul>
<li><a href="https://www.okpay.com/ru/developers/shop-systems/index.html">Системы магазинов</a></li>
<ul class="subitem">
<li><a href="https://www.okpay.com/ru/developers/shop-systems/index.html">Обзор</a></li>
<li><a href="https://www.okpay.com/ru/developers/shop-systems/request.html">Запрос интеграции</a></li>
</ul>
</ul>
</div>
</div>
</div>
</div>
</div>
<div id="dvcontent" style="width:60%;" class=" content">
<div id="dvInnercontent" style="margin-right:13px;" class="round-border">
<ul class="navchain">
<li><a href="https://www.okpay.com/ru/index.html">Главная</a></li><li><a href="https://www.okpay.com/ru/developers/index.html">Разработчикам</a></li><li><a href="https://www.okpay.com/ru/developers/ipn/index.html">Уведомление об оплате</a></li>
</ul>
<h1 id="H1Title">Реализация IPN обработчика</h1>
<style type="text/css">div.text h3 {cursor:pointer;} #wrap div.hidden p {margin-top:0;}</style>
<link href="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/prettify.css" rel="stylesheet" type="text/css">
<script src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/prettify.js" type="text/javascript"></script>
<script type="text/javascript">
$(function() {
$('div.text div.hidden').hide();
$('div.text h3').click(function() {
var n = $("div.open").length;
if (n == 0) {
$(this).next().addClass('open');
$(this).next().slideToggle("normal");
}
else {
var lnk = $(this);
$('div.open').slideToggle("normal", function() {
if ($(this).text().length == $(lnk).next().text().length) { return; }
$(lnk).next().addClass('open');
$(lnk).next().slideToggle("normal");
});
$('div.hidden').removeClass("open");
}
});
$("div#dvInnercontent pre").attr("class", "prettyprint").attr("dir", "ltr") ;
prettyPrint();
});
</script>
<p>Для обработки платежа вы должны написать IPN обработчик на выбранном вами языке программирования и разместить его на вашем веб-сервере. Вы можете использовать предоставленный ниже образец кода в качестве отправной точки.</p>
<p>Хорошая практика программирования: ваш IPN обработчик получает POST запрос от OKPAY и сразу же отправляет его другой процедуре (процессу), которая обрабатывает бизнес-логику связанную с сообщением. Если обработчик структурирован таким образом, это будет простой и четкий цикл, который принимает сообщение и отправляет на обработку бизнес-логике вашего приложения.</p>
<p>Ваша программа-обработчик должна:</p>
<ol>
<li>Ожидать HTTP POST запрос от OKPAY.</li>
<li>Создать запрос, который содержит такой же набор переменных IPN и их значений с добавлением <strong>ok_verify=true</strong></li>
<li>Отправить запрос обратно на  <strong>okpay.com/ipn-verify.html</strong></li>
<li> Дождаться ответа от OKPAY, который может быть либо VERIFIED или INVALID (в случае тестирования через IPN симулятор - ответ TEST или INVALID).</li>
<li>Если ответ VERIFIED, проверьте следующее:
<ul>
<li>Убедитесь, что статус платежа равен <em>завершен</em> (<code>ok_txn_status=completed</code>).<br>
OKPAY передает IPN сообщения также и для платежей со статусом <em>ожидание</em> и <em>сбой</em>; не отправляйте заказ, пока платеж не будет успешно <em>завершен</em>.</li>
<li>Используйте идентификатор операции (<code>ok_txn_id</code>) чтобы убедиться, что данная сделка еще не была обработана, что препятствует повторной обработке одной и той же операции.<br>
Как правило, вы должны хранить идентификаторы операций в вашей базе данных, чтобы убедиться что вы обрабатываете новую операцию.<br>
</li>
<li>Проверьте, что адрес электронной почты получателя (<code>ok_receiver_email</code>) это ваш адрес.<br>
Эта проверка обеспечивает дополнительную защиту от мошенничества.</li>
<li>Убедитесь, что цена, валюта, описание предмета, и так далее, соотвествуют сделке на вашем сайте.<br>
Эта проверка обеспечивает дополнительную защиту от мошенничества.</li>
</ul>
</li>
<li>Если запрос проходит проверку, принимайте решение на основе значения переменной <code>ok_txn_status</code>, в противном случае принимайте решение на основе значения переменной <code>ok_txn_pending_reason</code>.</li>
<li> Если ответ INVALID, сохраните сообщение для дальнейшего расследования.</li>
</ol>
<h2>Примеры кода обработчиков</h2>
<p>Здесь вы можете найти образцы исходного кода обработчиков написанных на популярных языках программирования.</p>
<div class="text">
<h3><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/prog-php.png" width="80" height="48" alt="PHP"> Пример на PHP</h3>
<div class="hidden" style="display: none; ">
<p>Данный обработчик написан на PHP. Вы можете использовать код этого обработчика в качестве отправной точки для написания вашего собственного. Обработчик может принять решение в зависимости от типа и статуса операции.</p>
<pre style="overflow-x: scroll;" class="prettyprint" dir="ltr"><span class="pun">&lt;?</span><span class="pln">php</span><br><br><span class="pln">error_reporting</span><span class="pun">(</span><span class="pln">E_ALL </span><span class="pun">^</span><span class="pln"> E_NOTICE</span><span class="pun">);</span><span class="pln"> </span><br><span class="pln">$email </span><span class="pun">=</span><span class="pln"> </span><span class="str">"yourmail@mail.com"</span><span class="pun">;</span><span class="pln"> </span><span class="com">// &lt;------ change to your email address!!!</span><br><span class="pln">$header </span><span class="pun">=</span><span class="pln"> </span><span class="str">""</span><span class="pun">;</span><span class="pln"> </span><br><span class="pln">$emailtext </span><span class="pun">=</span><span class="pln"> </span><span class="str">"EMIAL"</span><span class="pun">;</span><span class="pln"> </span><br><span class="pln"> </span><br><span class="com">// Read the post from OKPAY and add 'ok_verify' </span><br><span class="pln">$req </span><span class="pun">=</span><span class="pln"> </span><span class="str">'ok_verify=true'</span><span class="pun">;</span><span class="pln"> </span><br><br><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$_POST </span><span class="kwd">as</span><span class="pln"> $key </span><span class="pun">=&gt;</span><span class="pln"> $value</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">$value </span><span class="pun">=</span><span class="pln"> urlencode</span><span class="pun">(</span><span class="pln">stripslashes</span><span class="pun">(</span><span class="pln">$value</span><span class="pun">));</span><br><span class="pln">$req </span><span class="pun">.=</span><span class="pln"> </span><span class="str">"&amp;$key=$value"</span><span class="pun">;</span><br><span class="pun">}</span><br><br><br><br><span class="com">// Post back to OKPAY to validate </span><br><span class="pln">$header </span><span class="pun">.=</span><span class="pln"> </span><span class="str">"POST /ipn-verify.html HTTP/1.0\r\n"</span><span class="pun">;</span><span class="pln"> </span><br><span class="pln">$header </span><span class="pun">.=</span><span class="pln"> </span><span class="str">"Host: www.okpay.com\r\n"</span><span class="pun">;</span><span class="pln"> </span><br><span class="pln">$header </span><span class="pun">.=</span><span class="pln"> </span><span class="str">"Content-Type: application/x-www-form-urlencoded\r\n"</span><span class="pun">;</span><span class="pln"> </span><br><span class="pln">$header </span><span class="pun">.=</span><span class="pln"> </span><span class="str">"Content-Length: "</span><span class="pln"> </span><span class="pun">.</span><span class="pln"> strlen</span><span class="pun">(</span><span class="pln">$req</span><span class="pun">)</span><span class="pln"> </span><span class="pun">.</span><span class="pln"> </span><span class="str">"\r\n\r\n"</span><span class="pun">;</span><span class="pln"> </span><br><span class="pln">$fp </span><span class="pun">=</span><span class="pln"> fsockopen </span><span class="pun">(</span><span class="str">'www.okpay.com'</span><span class="pun">,</span><span class="pln"> </span><span class="lit">80</span><span class="pun">,</span><span class="pln"> $errno</span><span class="pun">,</span><span class="pln"> $errstr</span><span class="pun">,</span><span class="pln"> </span><span class="lit">30</span><span class="pun">);</span><span class="pln"> </span><br><span class="pln"> </span><br><span class="com">// Process validation from OKPAY</span><br><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">$fp</span><span class="pun">)</span><span class="pln"> </span><br><span class="pun">{</span><br><span class="pln">  </span><span class="com">// HTTP ERROR</span><br><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><br><span class="pun">{</span><br><span class="pln">  </span><span class="com">// NO HTTP ERROR  </span><br><span class="pln">  fputs </span><span class="pun">(</span><span class="pln">$fp</span><span class="pun">,</span><span class="pln"> $header </span><span class="pun">.</span><span class="pln"> $req</span><span class="pun">);</span><span class="pln"> </span><br><span class="pln">  </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">feof</span><span class="pun">(</span><span class="pln">$fp</span><span class="pun">))</span><br><span class="pln">  </span><span class="pun">{</span><span class="pln"> </span><br><span class="pln">    $res </span><span class="pun">=</span><span class="pln"> fgets </span><span class="pun">(</span><span class="pln">$fp</span><span class="pun">,</span><span class="pln"> </span><span class="lit">1024</span><span class="pun">);</span><span class="pln"> </span><br><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">strcmp </span><span class="pun">(</span><span class="pln">$res</span><span class="pun">,</span><span class="pln"> </span><span class="str">"VERIFIED"</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><br><span class="pln">    </span><span class="pun">{</span><span class="pln"> </span><br><span class="pln">      </span><span class="com">// TODO: </span><br><span class="pln">      </span><span class="com">// Check the "ok_txn_status" is "completed"</span><br><span class="pln">      </span><span class="com">// Check that "ok_txn_id" has not been previously processed </span><br><span class="pln">      </span><span class="com">// Check that "ok_receiver_email" is your OKPAY email address</span><br><span class="pln">      </span><span class="com">// Check that "txn_txn_gross"/"ok_txn_currency" are correct </span><br><span class="pln">      </span><span class="com">// Process payment </span><br><span class="pln">     </span><br><span class="pln">      </span><span class="com">// If 'VERIFIED', send an email of IPN variables and values to the </span><br><span class="pln">      </span><span class="com">// specified email address </span><br><span class="pln">      </span><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$_POST </span><span class="kwd">as</span><span class="pln"> $key </span><span class="pun">=&gt;</span><span class="pln"> $value</span><span class="pun">){</span><span class="pln"> </span><br><span class="pln">        $emailtext </span><span class="pun">.=</span><span class="pln"> $key </span><span class="pun">.</span><span class="pln"> </span><span class="str">" = "</span><span class="pln"> </span><span class="pun">.</span><span class="pln">$value </span><span class="pun">.</span><span class="str">"\n\n"</span><span class="pun">;</span><span class="pln"> </span><br><span class="pln">      </span><span class="pun">}</span><span class="pln"> </span><br><span class="pln">      mail</span><span class="pun">(</span><span class="pln">$email</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Live-VERIFIED IPN"</span><span class="pun">,</span><span class="pln"> $emailtext </span><span class="pun">.</span><span class="pln"> </span><span class="str">"\n\n"</span><span class="pln"> </span><span class="pun">.</span><span class="pln"> $req </span><span class="pun">.</span><span class="pln"> </span><span class="str">"\n\n"</span><span class="pln"> </span><span class="pun">.</span><span class="pln"> $res</span><span class="pun">);</span><span class="pln"> </span><br><span class="pln">    </span><span class="pun">}</span><br><span class="pln">    </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">strcmp </span><span class="pun">(</span><span class="pln">$res</span><span class="pun">,</span><span class="pln"> </span><span class="str">"INVALID"</span><span class="pun">)</span><span class="pln"> </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><br><span class="pln">    </span><span class="pun">{</span><span class="pln"> </span><br><span class="pln">      </span><span class="com">// If 'INVALID', send an email. TODO: Log for manual investigation. </span><br><span class="pln">      </span><span class="kwd">foreach</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$_POST </span><span class="kwd">as</span><span class="pln"> $key </span><span class="pun">=&gt;</span><span class="pln"> $value</span><span class="pun">)</span><br><span class="pln">      </span><span class="pun">{</span><span class="pln"> </span><br><span class="pln">        $emailtext </span><span class="pun">.=</span><span class="pln"> $key </span><span class="pun">.</span><span class="pln"> </span><span class="str">" = "</span><span class="pln"> </span><span class="pun">.</span><span class="pln">$value </span><span class="pun">.</span><span class="str">"\n\n"</span><span class="pun">;</span><span class="pln"> </span><br><span class="pln">      </span><span class="pun">}</span><span class="pln"> </span><br><span class="pln">      mail</span><span class="pun">(</span><span class="pln">$email</span><span class="pun">,</span><span class="pln"> </span><span class="str">"Live-INVALID IPN"</span><span class="pun">,</span><span class="pln"> $emailtext </span><span class="pun">.</span><span class="pln"> </span><span class="str">"\n\n"</span><span class="pln"> </span><span class="pun">.</span><span class="pln"> $req </span><span class="pun">.</span><span class="pln"> </span><span class="str">"\n\n"</span><span class="pln"> </span><span class="pun">.</span><span class="pln"> $res</span><span class="pun">);</span><span class="pln"> </span><br><span class="pln">    </span><span class="pun">}</span><span class="pln"> </span><br><span class="pln">    </span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">strcmp </span><span class="pun">(</span><span class="pln">$res</span><span class="pun">,</span><span class="pln"> </span><span class="str">"TEST"</span><span class="pun">)==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><br><span class="pln">    </span><span class="pun">{</span><br><span class="pln">	mail</span><span class="pun">(</span><span class="pln">$email</span><span class="pun">,</span><span class="pln"> </span><span class="str">"TEST IPN"</span><span class="pun">,</span><span class="pln"> $emailtext </span><span class="pun">.</span><span class="pln"> </span><span class="str">"\n\n"</span><span class="pln"> </span><span class="pun">.</span><span class="pln"> $req </span><span class="pun">.</span><span class="pln"> </span><span class="str">"\n\n"</span><span class="pln"> </span><span class="pun">.</span><span class="pln"> $res</span><span class="pun">);</span><span class="pln">  </span><br><span class="pln">    </span><span class="pun">}</span><br><span class="pln">  </span><span class="pun">}</span><span class="pln"> </span><br><span class="pln">  fclose </span><span class="pun">(</span><span class="pln">$fp</span><span class="pun">);</span><span class="pln"> </span><br><span class="pun">}</span><br><br><span class="pun">?&gt;</span><br></pre>
</div>
</div>
<div class="text">
<h3><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/prog-csharp.png" width="80" height="48" alt="C#"> Пример на C#</h3>
<div class="hidden" style="display: none; ">
Данный обработчик написан на C#. Вы можете использовать код этого обработчика в качестве отправной точки для написания вашего собственного. Обработчик может принять решение в зависимости от типа и статуса операции.
<pre style="overflow-x: scroll;" class="prettyprint" dir="ltr"><span class="kwd">using</span><span class="pln"> </span><span class="typ">System</span><span class="pun">;</span><br><span class="kwd">using</span><span class="pln"> </span><span class="typ">System</span><span class="pun">.</span><span class="pln">IO</span><span class="pun">;</span><br><span class="kwd">using</span><span class="pln"> </span><span class="typ">System</span><span class="pun">.</span><span class="typ">Text</span><span class="pun">;</span><br><span class="kwd">using</span><span class="pln"> </span><span class="typ">System</span><span class="pun">.</span><span class="typ">Net</span><span class="pun">;</span><br><span class="kwd">using</span><span class="pln"> </span><span class="typ">System</span><span class="pun">.</span><span class="typ">Web</span><span class="pun">;</span><br><br><span class="kwd">public</span><span class="pln"> </span><span class="kwd">partial</span><span class="pln"> </span><span class="kwd">class</span><span class="pln"> csIPNexample </span><span class="pun">:</span><span class="pln"> </span><span class="typ">System</span><span class="pun">.</span><span class="typ">Web</span><span class="pun">.</span><span class="pln">UI</span><span class="pun">.</span><span class="typ">Page</span><br><span class="pun">{</span><br><br><span class="kwd">protected</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> </span><span class="typ">Page_Load</span><span class="pun">(</span><span class="kwd">object</span><span class="pln"> sender</span><span class="pun">,</span><span class="pln"> </span><span class="typ">EventArgs</span><span class="pln"> e</span><span class="pun">)</span><br><span class="pun">{</span><br><br><span class="typ">HttpWebRequest</span><span class="pln"> req </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">HttpWebRequest</span><span class="pun">)</span><span class="typ">WebRequest</span><span class="pun">.</span><span class="typ">Create</span><span class="pun">(</span><span class="str">"https://www.okpay.com/ipn-verify.html"</span><span class="pun">);</span><br><br><span class="pln">    </span><span class="com">//Set values for the request back</span><br><span class="pln">    req</span><span class="pun">.</span><span class="typ">Method</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="str">"POST"</span><span class="pun">;</span><br><span class="pln">    req</span><span class="pun">.</span><span class="typ">ContentType</span><span class="pln"> </span><span class="pun">=</span><span class="pln">   </span><span class="str">"application/x-www-form-urlencoded"</span><span class="pun">;</span><br><span class="pln">    </span><span class="kwd">byte</span><span class="pun">[]</span><span class="pln"> param </span><span class="pun">=</span><span class="pln">   </span><span class="typ">Request</span><span class="pun">.</span><span class="typ">BinaryRead</span><span class="pun">(</span><span class="typ">HttpContext</span><span class="pun">.</span><span class="typ">Current</span><span class="pun">.</span><span class="typ">Request</span><span class="pun">.</span><span class="typ">ContentLength</span><span class="pun">);</span><br><span class="pln">    </span><span class="kwd">string</span><span class="pln">   strRequest </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Encoding</span><span class="pun">.</span><span class="pln">ASCII</span><span class="pun">.</span><span class="typ">GetString</span><span class="pun">(</span><span class="pln">param</span><span class="pun">);</span><br><span class="pln">    strRequest </span><span class="pun">+=</span><span class="pln"> </span><span class="str">"&amp;ok_verify=true"</span><span class="pun">;</span><br><span class="pln">    req</span><span class="pun">.</span><span class="typ">ContentLength</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> strRequest</span><span class="pun">.</span><span class="typ">Length</span><span class="pun">;</span><br><br><span class="pln">    </span><span class="com">//for proxy</span><br><span class="pln">    </span><span class="com">//WebProxy proxy = new WebProxy(new Uri("http://url:port#"));</span><br><span class="pln">    </span><span class="com">//req.Proxy = proxy;</span><br><br><br><span class="com">//Send the request to OKPAY and get the response</span><br><span class="pln">    </span><span class="typ">StreamWriter</span><span class="pln"> streamOut </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">StreamWriter</span><span class="pun">(</span><span class="pln">req</span><span class="pun">.</span><span class="typ">GetRequestStream</span><span class="pun">(),</span><span class="pln"> </span><span class="typ">System</span><span class="pun">.</span><span class="typ">Text</span><span class="pun">.</span><span class="typ">Encoding</span><span class="pun">.</span><span class="pln">ASCII</span><span class="pun">);</span><br><span class="pln">    streamOut</span><span class="pun">.</span><span class="typ">Write</span><span class="pun">(</span><span class="pln">strRequest</span><span class="pun">);</span><br><span class="pln">    streamOut</span><span class="pun">.</span><span class="typ">Close</span><span class="pun">();</span><br><span class="pln">    </span><span class="typ">StreamReader</span><span class="pln"> streamIn </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">StreamReader</span><span class="pun">(</span><span class="pln">req</span><span class="pun">.</span><span class="typ">GetResponse</span><span class="pun">().</span><span class="typ">GetResponseStream</span><span class="pun">());</span><br><span class="pln">    </span><span class="kwd">string</span><span class="pln"> strResponse </span><span class="pun">=</span><span class="pln"> streamIn</span><span class="pun">.</span><span class="typ">ReadToEnd</span><span class="pun">();</span><br><span class="pln">    streamIn</span><span class="pun">.</span><span class="typ">Close</span><span class="pun">();</span><br><br><span class="pln">    </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">strResponse </span><span class="pun">==</span><span class="pln"> </span><span class="str">"VERIFIED"</span><span class="pun">)</span><br><span class="pln">    </span><span class="pun">{</span><br><span class="pln">      </span><span class="com">//check the "ok_txn_status" is "completed"</span><br><span class="pln">      </span><span class="com">//check that "ok_txn_id" has not been previously processed</span><br><span class="pln">      </span><span class="com">//check that "ok_receiver_email" is your OKPAY email</span><br><span class="pln">      </span><span class="com">//check that "ok_txn_gross"/"ok_txn_currency" are correct</span><br><span class="pln">      </span><span class="com">//process payment</span><br><span class="pln">    </span><span class="pun">}</span><br><span class="pln">    </span><span class="kwd">else</span><span class="pln">   </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">strResponse </span><span class="pun">==</span><span class="pln"> </span><span class="str">"INVALID"</span><span class="pun">)</span><br><span class="pln">    </span><span class="pun">{</span><br><span class="pln">      </span><span class="com">//log for manual investigation</span><br><span class="pln">    </span><span class="pun">}</span><br><span class="pln">    </span><span class="kwd">else</span><br><span class="pln">    </span><span class="pun">{</span><br><span class="pln">      </span><span class="com">//log response/ipn data for manual investigation</span><br><span class="pln">    </span><span class="pun">}</span><br><span class="pln">  </span><span class="pun">}</span><br><span class="pun">}</span><br></pre>
</div>
</div>
<div class="text">
<h3><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/prog-vb.png" width="80" height="48" alt="Visual Basic"> Пример на VB</h3>
<div class="hidden" style="display: none; ">
<p>Данный обработчик написан на  Visual Basic. Вы можете использовать код этого обработчика в качестве отправной точки для написания вашего собственного. Обработчик может принять решение в зависимости от типа и статуса операции.</p>
<pre style="overflow-x: scroll;" class="prettyprint" dir="ltr"><span class="typ">Imports</span><span class="pln"> </span><span class="typ">System</span><span class="pun">.</span><span class="typ">Net</span><br><span class="typ">Imports</span><span class="pln"> </span><span class="typ">System</span><span class="pun">.</span><span class="pln">IO</span><br><br><span class="typ">Partial</span><span class="pln"> </span><span class="typ">Class</span><span class="pln"> vbIPNexample</span><br><span class="typ">Inherits</span><span class="pln"> </span><span class="typ">System</span><span class="pun">.</span><span class="typ">Web</span><span class="pun">.</span><span class="pln">UI</span><span class="pun">.</span><span class="typ">Page</span><br><br><span class="typ">Protected</span><span class="pln"> </span><span class="typ">Sub</span><span class="pln"> </span><span class="typ">Page_Load</span><span class="pun">(</span><span class="typ">ByVal</span><span class="pln"> sender </span><span class="typ">As</span><span class="pln"> </span><span class="typ">Object</span><span class="pun">,</span><span class="pln"> </span><span class="typ">ByVal</span><span class="pln"> e </span><span class="typ">As</span><span class="pln"> </span><span class="typ">System</span><span class="pun">.</span><span class="typ">EventArgs</span><span class="pun">)</span><span class="pln"> </span><span class="typ">Handles</span><span class="pln">   </span><span class="typ">Me</span><span class="pun">.</span><span class="typ">Load</span><br><span class="typ">Dim</span><span class="pln"> req </span><span class="typ">As</span><span class="pln"> </span><span class="typ">HttpWebRequest</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">CType</span><span class="pun">(</span><span class="typ">WebRequest</span><span class="pun">.</span><span class="typ">Create</span><span class="pun">(</span><span class="str">"https://www.okpay.com/ipn-verify.html"</span><span class="pun">),</span><span class="pln"> </span><span class="typ">HttpWebRequest</span><span class="pun">)</span><br><br><span class="str">'Set   values for the request back</span><br><span class="str">req.Method = "POST"</span><br><span class="str">req.ContentType = "application/x-www-form-urlencoded"</span><br><span class="str">Dim Param() As Byte = Request.BinaryRead(HttpContext.Current.Request.ContentLength)</span><br><span class="str">Dim   strRequest As String = Encoding.ASCII.GetString(Param)</span><br><span class="str">strRequest = strRequest + "&amp;ok_verify=true"</span><br><span class="str">req.ContentLength = strRequest.Length</span><br><br><span class="str">'</span><span class="kwd">for</span><span class="pln"> proxy</span><br><span class="str">'Dim proxy As New WebProxy(New System.Uri("http://url:port#"))</span><br><span class="str">'</span><span class="pln">req</span><span class="pun">.</span><span class="typ">Proxy</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> proxy</span><br><br><span class="str">'Send the request to OKPAY and get the response</span><br><span class="str">Dim streamOut As StreamWriter = New StreamWriter(req.GetRequestStream(), Encoding.ASCII)</span><br><span class="str">streamOut.Write(strRequest)</span><br><span class="str">streamOut.Close()</span><br><span class="str">Dim   streamIn As StreamReader = New StreamReader(req.GetResponse().GetResponseStream())</span><br><span class="str">Dim strResponse As String = streamIn.ReadToEnd()</span><br><span class="str">streamIn.Close()</span><br><br><span class="str">If strResponse = "VERIFIED" Then</span><br><span class="str">'</span><span class="pln">check the </span><span class="str">"ok_txn_status"</span><span class="pln"> </span><span class="kwd">is</span><span class="pln"> </span><span class="str">"completed"</span><br><span class="str">'check that "ok_txn_id" has not been previously processed</span><br><span class="str">'</span><span class="pln">check that </span><span class="str">"ok_receiver_email"</span><span class="pln"> </span><span class="kwd">is</span><span class="pln"> your OKPAY email</span><br><span class="str">'check that "ok_txn_gross"/"ok_txn_currency" are correct</span><br><span class="str">'</span><span class="pln">process payment</span><br><span class="typ">ElseIf</span><span class="pln"> strResponse </span><span class="pun">=</span><span class="pln"> </span><span class="str">"INVALID"</span><span class="pln"> </span><span class="typ">Then</span><br><span class="str">'log for manual investigation</span><br><span class="str">Else</span><br><span class="str">'</span><span class="typ">Response</span><span class="pln"> wasn</span><span class="str">'t VERIFIED or INVALID, log for manual investigation</span><br><span class="str">End If</span><br><span class="str">End Sub</span><br><span class="str">End Class</span><br></pre>
</div>
</div>
<div class="text">
<h3><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/prog-perl.png" width="80" height="48" alt="Perl"> Пример на Perl</h3>
<div class="hidden" style="display: none; ">
<p>Данный обработчик написан на  Perl. Вы можете использовать код этого обработчика в качестве отправной точки для написания вашего собственного. Обработчик может принять решение в зависимости от типа и статуса операции.</p>
<pre style="overflow-x: scroll;" class="prettyprint" dir="ltr"><span class="pun">(</span><span class="pln">requires LWP</span><span class="pun">::</span><span class="typ">UserAgent</span><span class="pun">)</span><br><br><span class="com">#!/usr/bin/perl</span><br><br><span class="com"># read   post from OKPAY system and add 'ok_verify'</span><br><span class="pln">read </span><span class="pun">(</span><span class="pln">STDIN</span><span class="pun">,</span><span class="pln"> $query</span><span class="pun">,</span><span class="pln"> $ENV</span><span class="pun">{</span><span class="str">'CONTENT_LENGTH'</span><span class="pun">});</span><br><span class="pln">$query </span><span class="pun">.=</span><span class="pln"> </span><span class="str">'&amp;ok_verify=true'</span><span class="pun">;</span><br><br><span class="com"># post back to OKPAY system to validate</span><br><span class="kwd">use</span><span class="pln"> LWP</span><span class="pun">::</span><span class="typ">UserAgent</span><span class="pun">;</span><br><span class="pln">$ua </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> LWP</span><span class="pun">::</span><span class="typ">UserAgent</span><span class="pun">;</span><br><span class="pln">$req </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> HTTP</span><span class="pun">::</span><span class="typ">Request</span><span class="pln"> </span><span class="str">'POST'</span><span class="pun">,</span><span class="str">'https://www.okpay.com/ipn-verify.html'</span><span class="pun">;</span><br><span class="pln">$req</span><span class="pun">-&gt;</span><span class="pln">content_type</span><span class="pun">(</span><span class="str">'application/x-www-form-urlencoded'</span><span class="pun">);</span><br><span class="pln">$req</span><span class="pun">-&gt;</span><span class="pln">content</span><span class="pun">(</span><span class="pln">$query</span><span class="pun">);</span><br><span class="pln">$res </span><span class="pun">=</span><span class="pln"> $ua</span><span class="pun">-&gt;</span><span class="pln">request</span><span class="pun">(</span><span class="pln">$req</span><span class="pun">);</span><br><br><span class="com"># split posted variables into pairs</span><br><span class="lit">@pairs</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> split</span><span class="pun">(</span><span class="str">/&amp;/</span><span class="pun">,</span><span class="pln"> $query</span><span class="pun">);</span><br><span class="pln">$count </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><br><span class="kwd">foreach</span><span class="pln"> $pair </span><span class="pun">(</span><span class="lit">@pairs</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">  </span><span class="pun">(</span><span class="pln">$name</span><span class="pun">,</span><span class="pln"> $value</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> split</span><span class="pun">(</span><span class="str">/=/</span><span class="pun">,</span><span class="pln"> $pair</span><span class="pun">);</span><br><span class="pln">  $value </span><span class="pun">=~</span><span class="pln"> tr</span><span class="pun">/+</span><span class="str">/ /</span><span class="pun">;</span><br><span class="pln">  $value </span><span class="pun">=~</span><span class="pln"> s</span><span class="pun">/%([</span><span class="pln">a</span><span class="pun">-</span><span class="pln">fA</span><span class="pun">-</span><span class="pln">F0</span><span class="pun">-</span><span class="lit">9</span><span class="pun">][</span><span class="pln">a</span><span class="pun">-</span><span class="pln">fA</span><span class="pun">-</span><span class="pln">F0</span><span class="pun">-</span><span class="lit">9</span><span class="pun">])/</span><span class="pln">pack</span><span class="pun">(</span><span class="str">"C"</span><span class="pun">,</span><span class="pln"> hex</span><span class="pun">(</span><span class="pln">$1</span><span class="pun">))/</span><span class="pln">eg</span><span class="pun">;</span><br><span class="pln">  $variable</span><span class="pun">{</span><span class="pln">$name</span><span class="pun">}</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> $value</span><span class="pun">;</span><br><span class="pln">  $count</span><span class="pun">++;</span><br><span class="pun">}</span><br><br><span class="com"># assign posted variables to local variables</span><br><span class="pln">$item_name </span><span class="pun">=</span><span class="pln"> $variable</span><span class="pun">{</span><span class="str">'ok_item_1_name'</span><span class="pun">};</span><br><span class="pln">$item_article </span><span class="pun">=</span><span class="pln"> $variable</span><span class="pun">{</span><span class="str">'ok_item_1_article'</span><span class="pun">};</span><br><span class="pln">$payment_status </span><span class="pun">=</span><span class="pln"> $variable</span><span class="pun">{</span><span class="str">'ok_txn_status'</span><span class="pun">};</span><br><span class="pln">$payment_amount </span><span class="pun">=</span><span class="pln"> $variable</span><span class="pun">{</span><span class="str">'ok_txn_gross'</span><span class="pun">};</span><br><span class="pln">$payment_currency </span><span class="pun">=</span><span class="pln"> $variable</span><span class="pun">{</span><span class="str">'ok_txn_currency'</span><span class="pun">};</span><br><span class="pln">$txn_id </span><span class="pun">=</span><span class="pln"> $variable</span><span class="pun">{</span><span class="str">'ok_txn_id'</span><span class="pun">};</span><br><span class="pln">$receiver_email </span><span class="pun">=</span><span class="pln"> $variable</span><span class="pun">{</span><span class="str">'ok_receiver_email'</span><span class="pun">};</span><br><span class="pln">$payer_email </span><span class="pun">=</span><span class="pln"> $variable</span><span class="pun">{</span><span class="str">'ok_payer_email'</span><span class="pun">};</span><br><br><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$res</span><span class="pun">-&gt;</span><span class="pln">is_error</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">  </span><span class="com"># HTTP error</span><br><span class="pun">}</span><br><span class="kwd">elsif</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$res</span><span class="pun">-&gt;</span><span class="pln">content eq </span><span class="str">'VERIFIED'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">  </span><span class="com"># check the $ok_txn_status=completed</span><br><span class="pln">  </span><span class="com"># check that $ok_txn_id has not been previously processed</span><br><span class="pln">  </span><span class="com"># check that $ok_receiver_email is your OKPAY email</span><br><span class="pln">  </span><span class="com"># check that $ok_txn_gross/$ok_txn_currency are correct</span><br><span class="pln">  </span><span class="com"># process payment</span><br><span class="pln">  </span><span class="pun">}</span><br><span class="pln">  </span><span class="kwd">elsif</span><span class="pln"> </span><span class="pun">(</span><span class="pln">$res</span><span class="pun">-&gt;</span><span class="pln">content eq </span><span class="str">'INVALID'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">    </span><span class="com"># log for manual investigation</span><br><span class="pln">  </span><span class="pun">}</span><br><span class="pln">  </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span><br><span class="pln">    </span><span class="com"># error</span><br><span class="pln">  </span><span class="pun">}</span><br><span class="kwd">print</span><span class="pln"> </span><span class="str">"content-type: text/plain\n\n"</span><span class="pun">;</span><span class="pln"> </span><br></pre>
</div>
</div>
<div class="text">
<h3><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/prog-java.png" width="80" height="48" alt="Java/JSP"> Пример на Java/JSP</h3>
<div class="hidden" style="display: none; ">
<p>Данный обработчик написан на  Java. Вы можете использовать код этого обработчика в качестве отправной точки для написания вашего собственного. Обработчик может принять решение в зависимости от типа и статуса операции.</p>
<pre style="overflow-x: scroll;" class="prettyprint" dir="ltr"><span class="pun">&lt;%@</span><span class="pln"> page </span><span class="kwd">import</span><span class="pun">=</span><span class="str">"java.util.*"</span><span class="pln"> %&gt;</span><br><span class="pun">&lt;%@</span><span class="pln"> page </span><span class="kwd">import</span><span class="pun">=</span><span class="str">"java.net.*"</span><span class="pln"> %&gt;</span><br><span class="pun">&lt;%@</span><span class="pln"> page </span><span class="kwd">import</span><span class="pun">=</span><span class="str">"java.io.*"</span><span class="pln"> %&gt;</span><br><br><span class="pun">&lt;%</span><br><span class="com">// read post from OKPAY system and add 'ok_verify'</span><br><span class="typ">Enumeration</span><span class="pln"> en </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">getParameterNames</span><span class="pun">();</span><br><span class="typ">String</span><span class="pln"> str </span><span class="pun">=</span><span class="pln"> </span><span class="str">"ok_verify=true"</span><span class="pun">;</span><br><span class="kwd">while</span><span class="pun">(</span><span class="pln">en</span><span class="pun">.</span><span class="pln">hasMoreElements</span><span class="pun">()){</span><br><span class="pln">  </span><span class="typ">String</span><span class="pln"> paramName </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">String</span><span class="pun">)</span><span class="pln">en</span><span class="pun">.</span><span class="pln">nextElement</span><span class="pun">();</span><br><span class="pln">  </span><span class="typ">String</span><span class="pln"> paramValue </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">getParameter</span><span class="pun">(</span><span class="pln">paramName</span><span class="pun">);</span><br><span class="pln">  str </span><span class="pun">=</span><span class="pln"> str </span><span class="pun">+</span><span class="pln"> </span><span class="str">"&amp;"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> paramName </span><span class="pun">+</span><span class="pln"> </span><span class="str">"="</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="typ">URLEncoder</span><span class="pun">.</span><span class="pln">encode</span><span class="pun">(</span><span class="pln">paramValue</span><span class="pun">);</span><br><span class="pun">}</span><br><br><span class="com">// post back to OKPAY system to validate</span><br><span class="com">// NOTE: change http: to https: in the following URL to verify using SSL (for increased security).</span><br><span class="com">// using HTTPS requires either Java 1.4 or greater, or Java Secure Socket Extension (JSSE)</span><br><span class="com">// and configured for older versions.</span><br><span class="pln">URL u </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> URL</span><span class="pun">(</span><span class="str">"https://www.okpay.com/ipn-verify.html"</span><span class="pun">);</span><br><span class="typ">URLConnection</span><span class="pln"> uc </span><span class="pun">=</span><span class="pln"> u</span><span class="pun">.</span><span class="pln">openConnection</span><span class="pun">();</span><br><span class="pln">uc</span><span class="pun">.</span><span class="pln">setDoOutput</span><span class="pun">(</span><span class="kwd">true</span><span class="pun">);</span><br><span class="pln">uc</span><span class="pun">.</span><span class="pln">setRequestProperty</span><span class="pun">(</span><span class="str">"Content-Type"</span><span class="pun">,</span><span class="str">"application/x-www-form-urlencoded"</span><span class="pun">);</span><br><span class="typ">PrintWriter</span><span class="pln"> pw </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">PrintWriter</span><span class="pun">(</span><span class="pln">uc</span><span class="pun">.</span><span class="pln">getOutputStream</span><span class="pun">());</span><br><span class="pln">pw</span><span class="pun">.</span><span class="pln">println</span><span class="pun">(</span><span class="pln">str</span><span class="pun">);</span><br><span class="pln">pw</span><span class="pun">.</span><span class="pln">close</span><span class="pun">();</span><br><br><span class="typ">BufferedReader</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">BufferedReader</span><span class="pun">(</span><br><span class="kwd">new</span><span class="pln"> </span><span class="typ">InputStreamReader</span><span class="pun">(</span><span class="pln">uc</span><span class="pun">.</span><span class="pln">getInputStream</span><span class="pun">()));</span><br><span class="typ">String</span><span class="pln"> res </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">in</span><span class="pun">.</span><span class="pln">readLine</span><span class="pun">();</span><br><span class="kwd">in</span><span class="pun">.</span><span class="pln">close</span><span class="pun">();</span><br><br><span class="com">// assign posted variables to local variables</span><br><span class="typ">String</span><span class="pln"> itemName </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">getParameter</span><span class="pun">(</span><span class="str">"ok_item_1_name"</span><span class="pun">);</span><br><span class="typ">String</span><span class="pln"> itemNumber </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">getParameter</span><span class="pun">(</span><span class="str">"ok_item_1_article"</span><span class="pun">);</span><br><span class="typ">String</span><span class="pln"> txnStatus </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">getParameter</span><span class="pun">(</span><span class="str">"ok_txn_status"</span><span class="pun">);</span><br><span class="typ">String</span><span class="pln"> txnGross </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">getParameter</span><span class="pun">(</span><span class="str">"ok_txn_gross"</span><span class="pun">);</span><br><span class="typ">String</span><span class="pln"> txnCurrency </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">getParameter</span><span class="pun">(</span><span class="str">"ok_txn_currency"</span><span class="pun">);</span><br><span class="typ">String</span><span class="pln"> txnId </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">getParameter</span><span class="pun">(</span><span class="str">"ok_txn_id"</span><span class="pun">);</span><br><span class="typ">String</span><span class="pln"> receiverEmail </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">getParameter</span><span class="pun">(</span><span class="str">"ok_receiver_email"</span><span class="pun">);</span><br><span class="typ">String</span><span class="pln"> payerEmail </span><span class="pun">=</span><span class="pln"> request</span><span class="pun">.</span><span class="pln">getParameter</span><span class="pun">(</span><span class="str">"ok_payer_email"</span><span class="pun">);</span><br><br><span class="pln">check notification validation</span><br><span class="kwd">if</span><span class="pun">(</span><span class="pln">res</span><span class="pun">.</span><span class="pln">equals</span><span class="pun">(</span><span class="str">"VERIFIED"</span><span class="pun">))</span><span class="pln"> </span><br><span class="pun">{</span><br><span class="pln">  </span><span class="com">// check that ok_txn_status=completed</span><br><span class="pln">  </span><span class="com">// check that ok_txn_id has not been previously processed</span><br><span class="pln">  </span><span class="com">// check that ok_receiver_email is your OKPAY email</span><br><span class="pln">  </span><span class="com">// check that ok_txn_gross/ok_txn_currency are correct</span><br><span class="pln">  </span><span class="com">// process payment</span><br><span class="pun">}</span><br><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">res</span><span class="pun">.</span><span class="pln">equals</span><span class="pun">(</span><span class="str">"INVALID"</span><span class="pun">))</span><span class="pln"> </span><br><span class="pun">{</span><br><span class="pln">  </span><span class="com">// log for investigation</span><br><span class="pun">}</span><br><span class="kwd">else</span><br><span class="pun">{</span><br><span class="pln">  </span><span class="com">// error</span><br><span class="pun">}</span><br><br><span class="pln">%&gt;</span><br></pre>
</div>
</div>
<div class="text">
<h3><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/prog-python.png" width="80" height="48" alt="Python"> Пример на Python</h3>
<div class="hidden" style="display: none; ">
<p>Данный обработчик написан на  Python. Вы можете использовать код этого обработчика в качестве отправной точки для написания вашего собственного. Обработчик может принять решение в зависимости от типа и статуса операции.</p>
<pre style="overflow-x: scroll;" class="prettyprint" dir="ltr"><span class="typ">Python</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Coming</span><span class="pln"> </span><span class="typ">Soon</span><span class="pun">.</span><br></pre>
</div>
</div>
<p>&nbsp;</p>
</div>
</div>
<div id="sbarlocal" class="sidebar-local">
<div id="dvSidesignup" class="signup">
<div class="inner">
<div class="r">
<a href="https://www.okpay.com/ru/account/signup.html" class="center">
<span style="display:block; margin-left:-42px;width:184px;">Открыть счет</span>
</a>
</div>
</div>
</div>
<div id="dvSidelogin" class="login">
<div class="wrap">
<div class="loginForm">
<h3>
Управление счетом
</h3>
<label for="txtLogin" id="Login_Email">Эл.почта</label>
<input name="ctl00$txtLogin" type="text" id="txtLogin" class="input">
<div style="clear:both; height: 5px;"></div>
<label for="txtPassword" id="Login_Password">Пароль</label>
<input name="ctl00$txtPassword" type="password" id="txtPassword" class="input">
<div style="clear:both; height: 5px;"></div>
<div style="margin-left:37%; margin-top:10px;">
<div class="input-button-block blue">
<input type="submit" name="ctl00$Login_btnLogin" value="Войти" id="Login_btnLogin">
</div>
</div>
<div style="clear:both;"></div>
<div class="link">
<a href="https://www.okpay.com/ru/account/forgot-password.html">
Забыли пароль?
</a>
</div>
<div class="link">
<a href="https://www.okpay.com/ru/account/email-recovery.html">
Забыли эл. почту?
</a>
</div>
</div>
</div>
</div>
<div class="debitcardlink">
<div class="wrap">
<div class="loginForm">
<h3>
Дебетовая карта OKPAY
</h3>
<a href="https://www.okpay.com/ru/services/debit-card/index.html" class="img">
<span style="display: block;padding-left:16px;padding-top:108px;">Введите Ваше имя</span>
</a>
</div>
</div>
</div>
<div id="shopSystem" class="shop-system">
<div class="inner">
<h3 class="r">
<a href="https://www.okpay.com/ru/developers/shop-systems/index.html">
Supported <br>
Shopping <br>
Carts
</a>
</h3>
</div>
<div class="list">
<a href="https://www.okpay.com/ru/developers/shop-systems/catalook/index.html" class="img"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/116346.jpg" alt="CATALook.netStore" title="CATALook.netStore"></a>
<a href="https://www.okpay.com/ru/developers/shop-systems/mals/index.html" class="img"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/141206.jpg" alt="Mal&#39;s e-commerce" title="Mal&#39;s e-commerce"></a>
<a href="https://www.okpay.com/ru/developers/shop-systems/easywebstore/index.html" class="img"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/130019.jpg" alt="easywebstore" title="easywebstore"></a>
<a href="https://www.okpay.com/ru/developers/shop-systems/sebercart/index.html" class="img"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/148664.jpg" alt="Seber Cart" title="Seber Cart"></a>
<a href="https://www.okpay.com/ru/developers/shop-systems/mycart/index.html" class="img"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/143692.jpg" alt="MyCart" title="MyCart"></a>
<a href="https://www.okpay.com/ru/developers/shop-systems/virtualshop/index.html" class="img"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/161094.jpg" alt="VirtualShop3" title="VirtualShop3"></a>
<a href="https://www.okpay.com/ru/developers/shop-systems/cubecart/index.html" class="img"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/123804.jpg" alt="CubeCart" title="CubeCart"></a>
<a href="https://www.okpay.com/ru/developers/shop-systems/ashopv/index.html" class="img"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/112617.jpg" alt="AShop V" title="AShop V"></a>
<a href="https://www.okpay.com/ru/developers/shop-systems/iasp/index.html" class="img"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/136234.jpg" alt="iASP" title="iASP"></a>
<a href="https://www.okpay.com/ru/developers/shop-systems/digistore/index.html" class="img"><img src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/126290.jpg" alt="Digistore" title="Digistore"></a>
<div style="clear:both;"></div>
</div>
</div>
<div id="dvRigthContent" class="document-contents">
</div>
</div>
</div>
<div style="clear:both;"></div>
<div>
<input type="hidden" name="__EVENTVALIDATION" id="__EVENTVALIDATION" value="/wEWBALqjeyFBQLT4e+AAwKB7cu1BQK4oP2ICsVc9j+wCnHrqDemAxINIkjHs6i7">
</div>
<script type="text/javascript" src="./OKPAY   Разработчикам   Уведомление об оплате   Реализация IPN обработчика_files/util.js"></script></form>
<div id="footer">
<div class="container">
<div class="round-border">
<div class="copyright">
<div>
<p style="text-align:right;">
<span>
Авторские права © 2007–2012 OKPAY Inc. Все права защищены.
</span>
</p>
</div>
<div>
<p style="text-align:left; margin-left:20px;">
<span id="spBottomLinks">
<a href="https://www.okpay.com/ru/index.html">Главная</a>
|
<a href="https://www.okpay.com/ru/site-map.html">Карта сайта</a>
|
<a href="https://www.okpay.com/ru/company/agreements/index.html">Юридические соглашения</a>
|
<a href="https://www.okpay.com/ru/company/index.html">Компания</a>
</span>
</p>
</div>
</div>
<div style="clear:both;"></div>
<div class="info">
<div>
<p style="text-align:right;">
OKPAY® это зарегистрированная торговая марка компании OKPAY Inc.<br>
Financial Services provided by UWC Financial Services Ltd.
</p>
</div>
<div>
<p style="text-align:left; margin-left:20px;">
OKPAY, Inc., VG1110, Mill Mall Tower, 2nd Floor, Wickhams Cay 1, <br> PO Box 4406, Road Town, Tortola, British Virgin Islands.
</p>
</div>
</div>
<div style="clear:both;"></div>
</div>
</div>
</div>
<script type="text/javascript">
$(function () {
langpanel(); preloadimg();
var pathname = window.location.pathname;
if (pathname.indexOf("ar") != -1 || pathname.indexOf("fa") != -1) {
if ($.browser.msie) {
$("div.form div.line").append("<span class='iefake'>&nbsp;</span>");
}
}
});
function SubmitOnEnter(myfield, e){
var keycode;if (window.event){keycode = window.event.keyCode;}
else if (e) keycode = e.which;
else return true;
if (keycode == 13){SearchSite();return false;}
else return true;}
function SearchSite(){
document.location.href='http://www.google.com/cse?cx=013398180710766064738:gwzrrk3zahi&ie=UTF-8&q=' +
document.getElementById('txtSearch').value + '&sa=Search';
}
</script>
<noscript>
&lt;div style="position:absolute; top:0; height:20px; background:#FFF"&gt;
&lt;p class="nonjsAlert"&gt;Примечание: многие функции на веб-сайте OKPAY требуют включенных JavaScript и Cookies. Вы должны включить эти опции в настройках браузера.&lt;/p&gt;
&lt;/div&gt;
</noscript>


<div style="display: none; " id="hiddenlpsubmitdiv"></div><script>try{for(var lastpass_iter=0; lastpass_iter < document.forms.length; lastpass_iter++){ var lastpass_f = document.forms[lastpass_iter]; if(typeof(lastpass_f.lpsubmitorig2)=="undefined"){ lastpass_f.lpsubmitorig2 = lastpass_f.submit; lastpass_f.submit = function(){ var form=this; var customEvent = document.createEvent("Event"); customEvent.initEvent("lpCustomEvent", true, true); var d = document.getElementById("hiddenlpsubmitdiv"); for(var i = 0; i < document.forms.length; i++){ if(document.forms[i]==form){ d.innerText=i; } } d.dispatchEvent(customEvent); form.lpsubmitorig2(); } } }}catch(e){}</script></body></html>